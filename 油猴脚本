// ==UserScript==
// @name         çŸ¥è¯†æ˜Ÿçƒ - å·²è¯»å¸–å­éšè— + åˆ é™¤ + å¯¼å‡º
// @namespace    http://tampermonkey.net/
// @version      1.9
// @description  éšè—å·²è¯»å’Œåˆ é™¤å†…å®¹ï¼Œå¹¶å­˜å‚¨åœ¨ localStorage ä¸­ï¼Œæ”¯æŒå¯¼å…¥/å¯¼å‡ºå·²è¯»è®°å½•
// @match        https://wx.zsxq.com/group/*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    const READ_STORAGE_KEY = 'zsxq_read_topics';   // ä¿å­˜å·²è¯»å¸–å­çš„é”®
    const DELETE_STORAGE_KEY = 'zsxq_deleted_topics'; // ä¿å­˜å·²åˆ é™¤å¸–å­çš„é”®

    function getReadList() {
        return JSON.parse(localStorage.getItem(READ_STORAGE_KEY) || '[]');
    }

    function saveReadList(list) {
        localStorage.setItem(READ_STORAGE_KEY, JSON.stringify(list));
    }

    function getDeletedList() {
        return JSON.parse(localStorage.getItem(DELETE_STORAGE_KEY) || '[]');
    }

    function saveDeletedList(list) {
        localStorage.setItem(DELETE_STORAGE_KEY, JSON.stringify(list));
    }

    function clearStorage() {
        localStorage.removeItem(READ_STORAGE_KEY);
        localStorage.removeItem(DELETE_STORAGE_KEY);
    }

    function markAsRead(topicId, topicContent) {
        const list = getReadList();
        const topicEntry = { id: topicId, content: topicContent };

        // å¦‚æœå·²è¯»åˆ—è¡¨ä¸­æœªåŒ…å«è¯¥ä¸»é¢˜ï¼Œåˆ™æ·»åŠ 
        if (!list.find(item => item.id === topicId)) {
            list.push(topicEntry);
            saveReadList(list);
        }
    }

    function init() {
        const readList = getReadList();           // è·å–å·²è¯»åˆ—è¡¨
        const deletedList = getDeletedList();     // è·å–å·²åˆ é™¤åˆ—è¡¨
        const topics = document.querySelectorAll('app-topic');

        // éå†æ¯ä¸ªå¸–å­
        topics.forEach((topic) => {
            const topicId = topic.getAttribute('_ngcontent-ng-c2545957520'); // è·å–å¸–å­ID
            const id = topicId || topic.innerText.slice(0, 30).trim(); // è·å–IDæˆ–æ­£æ–‡çš„å‰30ä¸ªå­—ç¬¦

            const topicContent = topic.innerText || ''; // è·å–å¸–å­æ­£æ–‡å†…å®¹

            // æ£€æŸ¥å¸–å­æ˜¯å¦åœ¨å·²åˆ é™¤åˆ—è¡¨ä¸­
            const isDeleted = deletedList.includes(id);
            if (isDeleted) {
                topic.style.display = 'none'; // å¦‚æœå·²åˆ é™¤åˆ™éšè—
                return; // è·³è¿‡åç»­å¤„ç†
            }

            // æ£€æŸ¥å¸–å­æ˜¯å¦åœ¨å·²è¯»åˆ—è¡¨ä¸­
            const isRead = readList.find(item => item.id === id);
            if (isRead) {
                topic.style.display = 'none'; // å¦‚æœå·²è¯»åˆ™éšè—
            } else {
                if (topic.querySelector('.action-buttons')) return; // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å·²å­˜åœ¨

                const actionContainer = document.createElement('div');
                actionContainer.className = 'action-buttons';
                actionContainer.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    display: flex;
                    gap: 5px; /* æŒ‰é’®ä¹‹é—´çš„é—´éš™ */
                `;

                const markAsReadBtn = document.createElement('button');
                markAsReadBtn.innerText = 'âœ… å·²è¯»';
                markAsReadBtn.className = 'mark-as-read-btn';
                markAsReadBtn.style.cssText = `
                    background-color: #4CAF50; /* ç»¿è‰²èƒŒæ™¯ */
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 4px 8px;
                    cursor: pointer;
                `;

                markAsReadBtn.onclick = (e) => {
                    e.stopPropagation();
                    topic.style.display = 'none';
                    markAsRead(id, topicContent); // ä¿å­˜å·²è¯»å¸–å­å†…å®¹
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.innerText = 'ğŸ—‘ï¸ åˆ é™¤';
                deleteBtn.className = 'delete-topic-btn';
                deleteBtn.style.cssText = `
                    background-color: #f44336; /* çº¢è‰²èƒŒæ™¯ */
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 4px 8px;
                    cursor: pointer;
                `;

                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    topic.style.display = 'none'; // ä»é¡µé¢ä¸Šéšè—
                    const deletedList = getDeletedList(); // è·å–å½“å‰çš„å·²åˆ é™¤åˆ—è¡¨
                    // æ›´æ–°å·²åˆ é™¤åˆ—è¡¨
                    if (!deletedList.includes(id)) {
                        deletedList.push(id);
                        saveDeletedList(deletedList); // æ›´æ–°æœ¬åœ°å­˜å‚¨
                    }
                };

                actionContainer.appendChild(markAsReadBtn);
                actionContainer.appendChild(deleteBtn);
                topic.style.position = 'relative';
                topic.appendChild(actionContainer);
            }
        });
    }

    function createExportImportPanel() {
        const panel = document.createElement('div');
        panel.style.cssText = `
            position: fixed;
            top: 10px;
            left: 10px;
            background: #fff;
            border: 1px solid #ccc;
            z-index: 9999;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        `;

        const exportBtn = document.createElement('button');
        exportBtn.innerText = 'ğŸ“¤ å¯¼å‡ºå·²è¯»å¸–å­';
        exportBtn.onclick = () => {
            const readList = getReadList();
            const data = JSON.stringify(readList, null, 2);
            navigator.clipboard.writeText(data).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
        };

        const clearBtn = document.createElement('button');
        clearBtn.innerText = 'ğŸ—‘ï¸ æ¸…é™¤æ•°æ®';
        clearBtn.style.cssText = `
            background-color: #ff9800; /* æ©™è‰²èƒŒæ™¯ */
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
        `;
        clearBtn.onclick = () => {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                clearStorage(); // æ¸…ç©ºæ‰€æœ‰æ•°æ®
                alert('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼Œè¯·åˆ·æ–°é¡µé¢æ¢å¤åŸæ ·ã€‚');
            }
        };

        panel.appendChild(exportBtn);
        panel.appendChild(clearBtn); // æ·»åŠ æ¸…é™¤æ•°æ®æŒ‰é’®
        document.body.appendChild(panel);
    }

    createExportImportPanel();

    setTimeout(() => {
        init();
        setInterval(init, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡å¸–å­
    }, 1000);
})();

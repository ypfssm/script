// ==UserScript==
// @name         çŸ¥è¯†æ˜Ÿçƒ - å·²è¯»å¸–å­éšè— + åˆ é™¤ + å¯¼å‡º
// @namespace    http://tampermonkey.net/
// @version      1.15
// @description  éšè—å·²è¯»å’Œåˆ é™¤å†…å®¹ï¼Œå¹¶å­˜å‚¨åœ¨ localStorage ä¸­ï¼Œæ”¯æŒæŒ‰ç»„å¯¼å…¥/å¯¼å‡ºå·²è¯»è®°å½•
// @match        https://wx.zsxq.com/group/*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    const GET_GROUP_ID = () => location.pathname.split('/').pop(); // èŽ·å–å½“å‰ç»„çš„ ID
    const READ_STORAGE_KEY = 'zsxq_read_topics_';  // é»˜è®¤é”®
    const DELETE_STORAGE_KEY = 'zsxq_deleted_topics_'; // é»˜è®¤é”®

    function getReadList() {
        return JSON.parse(localStorage.getItem(READ_STORAGE_KEY + GET_GROUP_ID()) || '[]');
    }

    function saveReadList(list) {
        localStorage.setItem(READ_STORAGE_KEY + GET_GROUP_ID(), JSON.stringify(list));
    }

    function getDeletedList() {
        return JSON.parse(localStorage.getItem(DELETE_STORAGE_KEY + GET_GROUP_ID()) || '[]');
    }

    function saveDeletedList(list) {
        localStorage.setItem(DELETE_STORAGE_KEY + GET_GROUP_ID(), JSON.stringify(list));
    }

    function clearStorage() {
        localStorage.removeItem(READ_STORAGE_KEY + GET_GROUP_ID());
        localStorage.removeItem(DELETE_STORAGE_KEY + GET_GROUP_ID());
    }

    function markAsRead(topicId, topicContent, topicImages) {
        const list = getReadList();
        const topicEntry = { id: topicId, content: topicContent, images: topicImages };

        if (!list.find(item => item.id === topicId)) {
            list.push(topicEntry);
            saveReadList(list);
        }
    }

    function init() {
        const readList = getReadList();
        const deletedList = getDeletedList();
        const topics = document.querySelectorAll('app-topic');

        topics.forEach((topic) => {
            const topicId = topic.getAttribute('_ngcontent-ng-c2545957520');
            const id = topicId || topic.innerText.slice(0, 30).trim();
            const topicContent = topic.innerText || '';

            // èŽ·å–å¸–å­ä¸­çš„æ‰€æœ‰å›¾ç‰‡ï¼Œè¿‡æ»¤æŽ‰å¤´åƒå’Œè¡¨æƒ…åŒ…é“¾æŽ¥
            const images = Array.from(topic.querySelectorAll('img'))
                .map(img => img.src)
                .filter(src =>
                    !src.includes('ignore-error') &&
                    !src.includes('assets_dweb/images/emoji/')
                );

            const isDeleted = deletedList.includes(id);
            if (isDeleted) {
                topic.style.display = 'none';
                return;
            }

            const isRead = readList.find(item => item.id === id);
            if (isRead) {
                topic.style.display = 'none';
            } else {
                if (topic.querySelector('.action-buttons')) return;

                const actionContainer = document.createElement('div');
                actionContainer.className = 'action-buttons';
                actionContainer.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    display: flex;
                    gap: 5px;
                `;

                const markAsReadBtn = document.createElement('button');
                markAsReadBtn.innerText = 'âœ… å·²è¯»';
                markAsReadBtn.className = 'mark-as-read-btn';
                markAsReadBtn.style.cssText = `
                    background-color: #4CAF50;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 4px 8px;
                    cursor: pointer;
                `;

                markAsReadBtn.onclick = (e) => {
                    e.stopPropagation();
                    topic.style.display = 'none';
                    markAsRead(id, topicContent, images);
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.innerText = 'ðŸ—‘ï¸ åˆ é™¤';
                deleteBtn.className = 'delete-topic-btn';
                deleteBtn.style.cssText = `
                    background-color: #f44336;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    padding: 4px 8px;
                    cursor: pointer;
                `;

                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    topic.style.display = 'none';
                    const deletedList = getDeletedList();
                    if (!deletedList.includes(id)) {
                        deletedList.push(id);
                        saveDeletedList(deletedList);
                    }
                };

                actionContainer.appendChild(markAsReadBtn);
                actionContainer.appendChild(deleteBtn);
                topic.style.position = 'relative';
                topic.appendChild(actionContainer);
            }
        });
    }

    function createExportImportPanel() {
        const panel = document.createElement('div');
        panel.style.cssText = `
            position: fixed;
            top: 10px;
            left: 10px;
            background: #fff;
            border: 1px solid #ccc;
            z-index: 9999;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        `;

        const exportBtn = document.createElement('button');
        exportBtn.innerText = 'ðŸ“¤ å¯¼å‡ºå·²è¯»å¸–å­';
        exportBtn.onclick = () => {
            const readList = getReadList();
            const data = JSON.stringify(readList, null, 2);
            navigator.clipboard.writeText(data).then(() => alert('å½“å‰ç»„çš„æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
        };

        const clearBtn = document.createElement('button');
        clearBtn.innerText = 'ðŸ—‘ï¸ æ¸…é™¤æ•°æ®';
        clearBtn.style.cssText = `
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
        `;
        clearBtn.onclick = () => {
            if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰ç»„çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                clearStorage();
                alert('å½“å‰ç»„çš„æ•°æ®å·²æ¸…é™¤ï¼Œè¯·åˆ·æ–°é¡µé¢æ¢å¤åŽŸæ ·ã€‚');
            }
        };

        panel.appendChild(exportBtn);
        panel.appendChild(clearBtn);
        document.body.appendChild(panel);
    }

    createExportImportPanel();
    setTimeout(() => {
        init();
        setInterval(init, 1000);
    }, 1000);
})();
